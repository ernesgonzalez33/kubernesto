<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdn.jsdelivr.net/; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;"><meta name=author content="Ernesto González"><meta name=description content="Using Sealed Secrets to deploy Helm Charts from GitHub"><meta name=keywords content="blog,developer,personal,productivity"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Sealed Secrets to encrypt secrets in a Helm Chart values file"><meta name=twitter:description content="Using Sealed Secrets to deploy Helm Charts from GitHub"><meta property="og:title" content="Using Sealed Secrets to encrypt secrets in a Helm Chart values file"><meta property="og:description" content="Using Sealed Secrets to deploy Helm Charts from GitHub"><meta property="og:type" content="article"><meta property="og:url" content="https://kubernesto.github.io/posts/secrets-charts/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-16T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-16T00:00:00+00:00"><title>Kubernesto</title><link rel=canonical href=https://kubernesto.github.io/posts/secrets-charts/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.6b1a4fbc48955b72aea7913e43fabeb45e8bc120da5aa41b598dd33adcac4b59.css integrity="sha256-axpPvEiVW3Kup5E+Q/q+tF6LwSDaWqQbWY3TOtysS1k=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/avatar.min.9d6304803131b10bb9632e1363b855aa6f2cc897ee5069788cb1171f5209111b.css integrity="sha256-nWMEgDExsQu5Yy4TY7hVqm8syJfuUGl4jLEXH1IJERs=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.110.0"></head><body class="preload-transitions colorscheme-dark"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Kubernesto</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://kubernesto.github.io/posts/secrets-charts/>Using Sealed Secrets to encrypt secrets in a Helm Chart values file</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-09-16T00:00:00Z>September 16, 2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/git/>Git</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/secret-management/>Secret Management</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/gitops/>GitOps</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/helm/>Helm</a></span></div></div></header><div><p>Reading the title of this post you may ask yourself: &ldquo;Why would I want to encrypt a secret and put it on a values file?&rdquo;. And to that, I would respond: &ldquo;Well, to push it to GitHub (or any equivalent), of course&rdquo;. And you would ask me again: &ldquo;But why would I want to push a secret to a public (or private, even) repository?&rdquo;, and I will answer: &ldquo;Well! Because GitOps!&rdquo;.</p><p>So what is GitOps? And why is this even a problem in the first place?</p><h2 id=gitops>GitOps
<a class=heading-link href=#gitops><i class="fa fa-link" aria-hidden=true></i></a></h2><p><a href=https://www.redhat.com/en/topics/devops/what-is-gitops#what-is-gitops>Red Hat</a> defines GitOps as a methodology that &ldquo;uses Git repositories as a single source of truth to deliver infrastructure as code. Submitted code checks the CI process, while the CD process checks and applies requirements for things like security, infrastructure as code, or any other boundaries set for the application framework. All code changes are tracked, making updates easy while also providing version control should a rollback be needed.&rdquo;</p><p>The most important part of that definition is the one that says that the Git repository is the <strong>single source of truth</strong>. So everything related to the application you want to develop and deploy needs to be in that Git repository. And you will ask: &ldquo;Does that include secrets?&rdquo;, and I will answer: &ldquo;Maybe&rdquo;. There are two ways:</p><ol><li>You can store the secrets encrypted in the Git repo.</li><li>You can create references to the secrets and with some automation create the Kubernetes Secret.</li></ol><p>For this article, we are going to cover the first methodology. And to be more specific, we are going to cover how to encrypt a secret with Sealed Secrets and use it in a Helm Chart.</p><h2 id=helm-charts-and-sealed-secrets>Helm Charts and Sealed Secrets
<a class=heading-link href=#helm-charts-and-sealed-secrets><i class="fa fa-link" aria-hidden=true></i></a></h2><p>If you are not familiar with Helm Charts, I invite you to read their <a href=https://helm.sh/docs/topics/charts/>documentation</a>, which has a lot of insights and explanations on how to use them.</p><p>And Sealed Secrets is a tool created by Bitnami Labs that lets you encrypt the secrets before sending them to the cluster. You will find a lot of information about it in their <a href=https://github.com/bitnami-labs/sealed-secrets>documentation</a>.</p><p>Usually, the way to handle sensitive information with Sealed Secrets is to create a Kubernetes <code>Secret</code> and encrypt it using <code>kubeseal</code> so it creates a <code>SealedSecret</code>. Then, you have to create that <code>SealedSecret</code> in the OpenShift cluster and the Sealed Secrets controller will decrypt it and create a K8s <code>Secret</code> with the information from the <code>SealedSecret</code>. A more detailed procedure can be found in their <a href=https://github.com/bitnami-labs/sealed-secrets#usage>usage</a> section of their documentation.</p><p>But the idea of this blog is to give the option of encrypting the secret directly in a Helm <code>Values</code> file. So we can&rsquo;t create the Sealed Secret that way, we will need to use the <code>raw</code> mode and paste the secret directly into the file. For that we will need to do the following:</p><blockquote><p><strong>NOTE:</strong> For this blog we are going to use the Hello Secret app, which is available at: <a href=https://github.com/ernesgonzalez33/hello-secret>https://github.com/ernesgonzalez33/hello-secret</a></p></blockquote><h3 id=install-sealed-secrets-in-openshift>Install Sealed Secrets in OpenShift
<a class=heading-link href=#install-sealed-secrets-in-openshift><i class="fa fa-link" aria-hidden=true></i></a></h3><p>First of all, add the Sealed Secrets repo:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets
</span></span></code></pre></div><p>Create the project where you want to install it:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>oc new-project sealed-secrets
</span></span></code></pre></div><p>Install it by using the values file in this repo:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>helm install sealed-secrets -f sealed-secrets/values.yaml sealed-secrets/sealed-secrets
</span></span></code></pre></div><h3 id=clone-hello-secret-repo>Clone Hello Secret repo
<a class=heading-link href=#clone-hello-secret-repo><i class="fa fa-link" aria-hidden=true></i></a></h3><p>Clone the Hello Secret App repo:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone git@github.com:ernesgonzalez33/hello-secret.git
</span></span></code></pre></div><h3 id=encrypt-your-secret>Encrypt your secret
<a class=heading-link href=#encrypt-your-secret><i class="fa fa-link" aria-hidden=true></i></a></h3><p>First, you will need to install kubeseal on your machine following these instructions:</p><ul><li><a href=https://github.com/bitnami-labs/sealed-secrets#homebrew>Homebrew</a></li><li><a href=https://github.com/bitnami-labs/sealed-secrets#macports>MacPorts</a></li><li><a href=https://github.com/bitnami-labs/sealed-secrets#nixpkgs>Nixpkgs</a></li><li><a href=https://github.com/bitnami-labs/sealed-secrets#linux>Linux</a></li><li><a href=https://github.com/bitnami-labs/sealed-secrets#installation-from-source>From Source</a></li></ul><p>Then, you will need to encrypt your secrets, and I&rsquo;m not meaning the entire K8s secret, but only the words/passwords you need encrypted. For that, run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo -n &lt;my-secret&gt; | kubeseal --controller-name=sealed-secrets --controller-namespace=sealed-secrets --raw --from-file=/dev/stdin --scope=namespace-wide
</span></span></code></pre></div><blockquote><p><strong>NOTE:</strong> The scope in the command needs to match with the selected in the Values file. By default, it is <code>namespace</code>. For more info: <a href=https://github.com/bitnami-labs/sealed-secrets#scopes>https://github.com/bitnami-labs/sealed-secrets#scopes</a></p></blockquote><p>The output of that command will be your secret encrypted. You will only need to paste it into the values file of the Hello Secret chart. Located under <code>chart/hello-secret/values.yaml</code></p><h3 id=deploy-hello-secret-using-the-helm-chart>Deploy Hello Secret using the Helm Chart
<a class=heading-link href=#deploy-hello-secret-using-the-helm-chart><i class="fa fa-link" aria-hidden=true></i></a></h3><p>Run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install hello-secret ./chart/hello-secret/
</span></span></code></pre></div><p>Follow the instructions from the <code>NOTES.txt</code> that will appear as an output of the previous command to test your application. You should see a message that says &ldquo;Hello&rdquo; and your secret in plain text.</p><h2 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Secrets management in GitOps is not an easy task, and every way of doing it has some advantages and disadvantages. With this blog, we only wanted to teach how to do it using Helm Charts and letting your installers encrypt the secrets directly in the <code>Values</code> file. It might not be the most secure way, but it is one of the most GitOps-y ones.</p><p>For more in-depth information about Secrets Management with GitOps, I highly recommend the following blog <a href=https://cloud.redhat.com/blog/a-guide-to-secrets-management-with-gitops-and-kubernetes>post</a>.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2022 -
2023
Ernesto González
·
Licensed under <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA-4.0</a>
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script></body></html>